{
  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "parameters": {
    "workspaceName": {
      "type": "string",
      "metadata": {
        "description": "Name of the Log Analytics workspace"
      }
    },
    "workspaceResourceId": {
      "type": "string",
      "metadata": {
        "description": "Full resource ID of the Log Analytics workspace"
      }
    }
  },
  "resources": [
    {
      "type": "Microsoft.Insights/scheduledQueryRules",
      "apiVersion": "2023-03-15-preview",
      "name": "Impossible Travel - Suspicious Sign-In Velocity",
      "location": "[resourceGroup().location]",
      "properties": {
        "displayName": "Impossible Travel - Suspicious Sign-In Velocity",
        "description": "Detects when a user successfully authenticates from two geographically distant locations within a time window that would require travelling faster than 900 km/h (commercial aircraft). Uses custom Haversine calculation on SigninLogs. Complements the built-in Entra ID Identity Protection 'impossibleTravel' detection.",
        "severity": 1,
        "enabled": true,
        "evaluationFrequency": "PT10M",
        "scopes": [
          "[parameters('workspaceResourceId')]"
        ],
        "windowSize": "PT1H",
        "criteria": {
          "allOf": [
            {
              "query": "let maxSpeedKmh = 900.0;\nlet minDistanceKm = 500.0;\nlet recentSignins =\n    SigninLogs\n    | where ResultType == 0\n    | where isnotempty(LocationDetails)\n    | extend Lat = todouble(LocationDetails.geoCoordinates.latitude)\n    | extend Lon = todouble(LocationDetails.geoCoordinates.longitude)\n    | where isnotnull(Lat) and isnotnull(Lon)\n    | project TimeGenerated, UserPrincipalName, IPAddress, Lat, Lon,\n              Country = tostring(LocationDetails.countryOrRegion),\n              City = tostring(LocationDetails.city),\n              AppDisplayName;\nrecentSignins\n| join kind=inner (\n    recentSignins\n    | project UserPrincipalName, PrevTime = TimeGenerated, PrevIP = IPAddress,\n              PrevLat = Lat, PrevLon = Lon, PrevCountry = Country, PrevCity = City\n) on UserPrincipalName\n| where TimeGenerated > PrevTime\n| extend DeltaLat = radians(Lat - PrevLat)\n| extend DeltaLon = radians(Lon - PrevLon)\n| extend A = sin(DeltaLat / 2) * sin(DeltaLat / 2)\n         + cos(radians(PrevLat)) * cos(radians(Lat)) * sin(DeltaLon / 2) * sin(DeltaLon / 2)\n| extend DistanceKm = 6371.0 * 2 * atan2(sqrt(A), sqrt(1 - A))\n| extend ElapsedHours = datetime_diff('minute', TimeGenerated, PrevTime) / 60.0\n| extend RequiredSpeedKmh = iff(ElapsedHours > 0, DistanceKm / ElapsedHours, real(null))\n| where DistanceKm > minDistanceKm\n| where RequiredSpeedKmh > maxSpeedKmh\n| project TimeGenerated, UserPrincipalName, NewLocation = strcat(City, \", \", Country),\n          NewIP = IPAddress, PrevLocation = strcat(PrevCity, \", \", PrevCountry), PrevIP,\n          DistanceKm = round(DistanceKm, 0),\n          ElapsedMinutes = datetime_diff('minute', TimeGenerated, PrevTime),\n          RequiredSpeedKmh = round(RequiredSpeedKmh, 0), AppDisplayName\n| order by RequiredSpeedKmh desc",
              "timeAggregation": "Count",
              "dimensions": [
                {
                  "name": "UserPrincipalName",
                  "operator": "Include",
                  "values": ["*"]
                }
              ],
              "operator": "GreaterThan",
              "threshold": 0,
              "failingPeriods": {
                "numberOfEvaluationPeriods": 1,
                "minFailingPeriodsToAlert": 1
              }
            }
          ]
        },
        "autoMitigate": false,
        "actions": {
          "actionGroups": [],
          "customProperties": {}
        }
      }
    }
  ]
}
